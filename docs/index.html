<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Streamflow Map</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 70vh; }
    #chart { width: 100%; height: 30vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="chart"></div>

  <script>
    fetch('global_streamflow.csv')
      .then(res => res.text())
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true, dynamicTyping: true }).data;

        const lons = data.map(row => row.long_pp);
        const lats = data.map(row => row.lat_pp);
        const nse = data.map(row => row.nse);
        const ids = data.map(row => row.gauge_id);
        const areas = data.map(row => row['area_cal_j']);

        const text = data.map(row =>
          `Gauge ID: ${row.gauge_id}` +
          `<br>NSE: ${row.nse?.toFixed(2)}` +
          `<br>KGE: ${row.kge?.toFixed(2)}` +
          `<br>Area: ${row['area_cal_j']?.toFixed(2)} km²` +
          `<br>Annual Precip.: ${row['pre_mm_syr']?.toFixed(2)} mm` +
          `<br>Annual min Temp.: ${(row['tmp_dc_smn'] / 10)?.toFixed(2)} °C` +
          `<br>Annual max Temp.: ${(row['tmp_dc_smx'] / 10)?.toFixed(2)} °C`
        );

        const trace = {
          type: 'scattergeo',
          mode: 'markers',
          lon: lons,
          lat: lats,
          text: text,
          customdata: data.map(row => ({
            id: row.gauge_id,
            area: row.area_cal_j
          })),
          marker: {
            size: 5,
            color: nse,
            colorscale: 'RdBu',
            cmin: -1,
            cmax: 1,
            colorbar: {
              title: 'NSE',
              tickmode: 'array',
              len: 0.6,
              thickness: 15
            },
            line: {
              width: 0.25,
              color: 'black'
            }
          }
        };

        const layout = {
          geo: {
            scope: 'world',
            showland: true,
            landcolor: 'rgb(217, 217, 217)',
            showocean: true,
            oceancolor: 'rgb(204, 229, 255)',
            showcountries: true,
            countrycolor: 'rgb(100, 100, 100)',
            showframe: false,
            projection: { type: 'natural earth' }
          },
          margin: { t: 0, r: 0, l: 0, b: 0 }
        };

        Plotly.newPlot('map', [trace], layout);

        // Click handler
        document.getElementById('map').on('plotly_click', function (event) {
          const point = event.points[0];
          const gaugeId = point.customdata.id;
          const area_km2 = point.customdata.area;

          const file = `obs_preds/${gaugeId}_output.csv`;
          fetch(file)
            .then(res => res.text())
            .then(csvText => {
              const parsed = Papa.parse(csvText, { header: true, dynamicTyping: true }).data;
              const dates = parsed.map(d => d.date);
              const obs = parsed.map(d => d.obs * area_km2 / 86.4);   // mm/day -> cms
              const pred = parsed.map(d => d.pred * area_km2 / 86.4); // mm/day -> cms

              const trace1 = {
                x: dates, y: obs,
                name: 'Observation',
                mode: 'lines'
              };
              const trace2 = {
                x: dates, y: pred,
                name: 'Prediction',
                mode: 'lines'
              };
              Plotly.newPlot('chart', [trace1, trace2], {
                title: `Gauge ${gaugeId}`,
                yaxis: {title: 'Streamflow (cms)'},
                margin: { t: 40 }
              });
            })
            .catch(err => {
              document.getElementById('chart').innerHTML = `<p style="color:red;padding:10px">Failed to load data for Gauge ID ${gaugeId}</p>`;
            });
        });
      });
  </script>
</body>
</html>
