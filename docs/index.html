<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Streamflow Map</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    let streamflowTrace;

    // Load streamflow data
    fetch('global_streamflow.csv')
      .then(response => response.text())
      .then(csvData => {
        const parsed = Papa.parse(csvData, {
          header: true,
          dynamicTyping: true
        }).data;

        const lons = parsed.map(row => row['long_pp']);
        const lats = parsed.map(row => row['lat_pp']);
        const nse = parsed.map(row => row['nse']);
        const text = parsed.map(row =>
          `Gauge ID: ${row.gauge_id}` +
          `<br>NSE: ${row.nse?.toFixed(2)}` +
          `<br>KGE: ${row.kge?.toFixed(2)}` +
          `<br>Area: ${row.area_cal_j?.toFixed(2)} km²` +
          `<br>Annual Precip.: ${row.pre_mm_syr?.toFixed(2)} mm` +
          `<br>Annual min Temp.: ${(row.tmp_dc_smn / 10)?.toFixed(2)} °C` +
          `<br>Annual max Temp.: ${(row.tmp_dc_smx / 10)?.toFixed(2)} °C`
        );

        streamflowTrace = {
          type: 'scattergeo',
          mode: 'markers',
          lon: lons,
          lat: lats,
          text: text,
          marker: {
            size: 5,
            color: nse,
            colorscale: 'RdBu',
            cmin: -1,
            cmax: 1,
            colorbar: {
              title: 'NSE',
              tickmode: 'array',
              len: 0.6,
              thickness: 15
            },
            line: {
              width: 0.25,
              color: 'black'
            }
          }
        };

        // After streamflow data is ready, load the boundary geojson
        loadAdminBoundaries();
      });

    function loadAdminBoundaries() {
      fetch('admin1_boundaries.geojson')
        .then(response => response.json())
        .then(geojsonData => {
          const boundaryTrace = {
            type: 'choropleth',
            geojson: geojsonData,
            locations: geojsonData.features.map((_, i) => i),
            z: geojsonData.features.map(() => 1),
            showscale: false,
            hoverinfo: 'skip',
            marker: {
              line: {
                color: 'gray',
                width: 0.5
              }
            },
            colorscale: [[0, 'rgba(0,0,0,0)'], [1, 'rgba(0,0,0,0)']]
          };

          const layout = {
            geo: {
              scope: 'world',
              showland: true,
              landcolor: 'rgb(217, 217, 217)',
              showocean: true,
              oceancolor: 'rgb(204, 229, 255)',
              showlakes: true,
              lakecolor: 'rgb(173, 216, 230)',
              showcountries: true,
              countrycolor: 'rgb(100, 100, 100)',
              showsubunits: true,
              subunitcolor: 'rgba(150,150,150,0.5)',
              showframe: false,
              projection: {
                type: 'natural earth'
              }
            },
            margin: { t: 0, r: 0, b: 0, l: 0 }
          };

          Plotly.newPlot('map', [boundaryTrace, streamflowTrace], layout);
        });
    }
  </script>
</body>
</html>
